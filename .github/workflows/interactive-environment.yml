name: Interactive Environment Creation

on:
  pull_request:
    types: [opened, synchronize, reopened]

# Ajout des permissions nÃ©cessaires
permissions:
  contents: read
  pull-requests: write
  issues: write

jobs:
  create-environment:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v3

      - name: Install ArgoCD CLI
        run: |
          curl -sSL -o argocd-linux-amd64 https://github.com/argoproj/argo-cd/releases/latest/download/argocd-linux-amd64
          sudo install -m 555 argocd-linux-amd64 /usr/local/bin/argocd
          rm argocd-linux-amd64

      - name: Setup Environment Bot
        id: setup-bot
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const services = [
              { name: 'nestjs-api', label: 'NestJS API' },
              { name: 'vue-frontend', label: 'Vue.js Frontend' },
              { name: 'prestashop', label: 'PrestaShop' },
              { name: 'mysql', label: 'MySQL' },
              { name: 'redis', label: 'Redis' }
            ];

            const ttlOptions = [
              { value: '1h', label: '1 hour' },
              { value: '24h', label: '24 hours' },
              { value: '7d', label: '7 days' },
              { value: '30d', label: '30 days' }
            ];

            const servicesCheckboxes = services.map(s => `- [ ] ${s.label}`).join('\n');
            const ttlOptionsList = ttlOptions.map(o => `- [ ] ${o.label} (${o.value})`).join('\n');

            const comment = `## ðŸš€ Environment Setup Bot

            Hi @${context.actor}! I'll help you set up your environment. Please answer the following questions:

            ### 1. Which services do you need?
            ${servicesCheckboxes}

            ### 2. How long should this environment exist?
            ${ttlOptionsList}

            ### 3. Resource Limits (Optional)
            Would you like to customize resource limits?
            - [ ] Yes, customize limits
            - [ ] No, use defaults

            Please check the boxes above and I'll create your environment accordingly.`;

            const response = await github.rest.issues.createComment({
              issue_number: context.issue.number,
              owner: context.repo.owner,
              repo: context.repo.repo,
              body: comment
            });

            core.setOutput('comment_id', response.data.id);

      - name: Monitor Responses
        uses: actions/github-script@v6
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const commentId = core.getInput('comment_id');

            // Function to check if all questions are answered
            const checkAnswers = async () => {
              console.log('Checking for user responses...');
              const comments = await github.rest.issues.listComments({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                per_page: 100
              });
              
              // Find the latest response from the user
              const userResponses = comments.data
                .filter(c => c.user.login === context.actor)
                .sort((a, b) => new Date(b.created_at) - new Date(a.created_at))[0];
              
              if (!userResponses) {
                console.log('No user responses found');
                return false;
              }
              
              console.log('Found user response:', userResponses.body);
              
              // Parse the response
              const services = ['nestjs-api', 'vue-frontend', 'prestashop', 'mysql', 'redis'];
              const selectedServices = services.filter(service => 
                userResponses.body.includes(`- [x] ${service}`)
              );
              
              console.log('Selected services:', selectedServices);
              
              const ttlMatch = userResponses.body.match(/\[x\] .* \((.*?)\)/);
              const ttl = ttlMatch ? ttlMatch[1] : null;
              
              console.log('Selected TTL:', ttl);
              
              if (!selectedServices.length || !ttl) {
                console.log('Missing required selections');
                return false;
              }
              
              // Create environment
              const envName = `env-${context.actor}-${context.issue.number}`;
              
              console.log('Creating environment:', envName);
              
              // Create ArgoCD application
              const application = {
                apiVersion: 'argoproj.io/v1alpha1',
                kind: 'Application',
                metadata: {
                  name: envName,
                  namespace: 'argocd',
                  annotations: {
                    'argocd.argoproj.io/ttl': ttl
                  }
                },
                spec: {
                  project: 'default',
                  source: {
                    repoURL: `${context.serverUrl}/${context.repo.owner}/${context.repo.repo}`,
                    targetRevision: context.payload.pull_request.head.ref,
                    path: 'gitops/charts/unified-app'
                  },
                  destination: {
                    server: 'https://kubernetes.default.svc',
                    namespace: envName
                  },
                  syncPolicy: {
                    automated: {
                      prune: true,
                      selfHeal: true
                    },
                    syncOptions: ['CreateNamespace=true']
                  },
                  helm: {
                    values: `
                      global:
                        environment: ${envName}
                        ttl:
                          enabled: true
                          duration: "${ttl}"
                      ${services.map(service => `
                      ${service}:
                        enabled: ${selectedServices.includes(service)}
                      `).join('\n')}
                    `
                  }
                }
              };
              
              // Create a new file with the ArgoCD application
              const fs = require('fs');
              fs.writeFileSync(
                `argocd-app-${envName}.yaml`,
                JSON.stringify(application, null, 2)
              );
              
              // Create a new success comment with instructions
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: context.issue.number,
                body: `## âœ… Environment Configuration Generated!
                
                Your environment configuration has been generated. To apply it locally:

                1. Download the generated file: \`argocd-app-${envName}.yaml\`
                2. Apply it to your local cluster:
                   \`\`\`bash
                   kubectl apply -f argocd-app-${envName}.yaml
                   \`\`\`
                
                **Configuration Details:**
                - **Environment Name:** \`${envName}\`
                - **TTL:** \`${ttl}\`
                - **Services:** \`${selectedServices.join(', ')}\`
                
                The environment will be automatically deleted after the specified TTL.`
              });
              
              return true;
            };

            // Poll for answers
            let attempts = 0;
            const maxAttempts = 10;

            while (attempts < maxAttempts) {
              if (await checkAnswers()) break;
              await new Promise(resolve => setTimeout(resolve, 60000)); // Wait 1 minute
              attempts++;
            }
